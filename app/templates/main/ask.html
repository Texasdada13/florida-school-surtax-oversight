{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Chat Interface -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Ask About Surtax Projects</h2>
            <p class="text-sm text-gray-500 mt-1">Ask questions about project budgets, schedules, vendors, or any surtax-related data.</p>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm max-w-2xl">
                    <p class="text-gray-700">Hello! I can help you find information about surtax projects. Try asking questions like:</p>
                    <ul class="mt-2 text-sm text-gray-600 space-y-1">
                        <li>&bull; "What projects are delayed?"</li>
                        <li>&bull; "Show me the biggest projects"</li>
                        <li>&bull; "How much has been spent on new construction?"</li>
                        <li>&bull; "Which vendors have the most contracts?"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="p-4 border-t border-gray-200">
            <form id="askForm" class="flex space-x-3">
                <input type="text" id="questionInput" placeholder="Type your question..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Quick Questions -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Quick Questions</h3>
        <div class="flex flex-wrap gap-2">
            <button onclick="askQuestion('What projects are behind schedule?')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors">Delayed projects</button>
            <button onclick="askQuestion('Which projects are over budget?')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors">Over budget</button>
            <button onclick="askQuestion('Show the largest projects by budget')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors">Largest projects</button>
            <button onclick="askQuestion('What is the total surtax budget?')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors">Total budget</button>
            <button onclick="askQuestion('List all active projects')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors">Active projects</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function askQuestion(question) {
    document.getElementById('questionInput').value = question;
    document.getElementById('askForm').dispatchEvent(new Event('submit'));
}

document.getElementById('askForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const input = document.getElementById('questionInput');
    const question = input.value.trim();
    if (!question) return;

    const messagesDiv = document.getElementById('chatMessages');

    // Add user message
    messagesDiv.innerHTML += `
        <div class="flex items-start space-x-3 justify-end">
            <div class="bg-blue-600 text-white rounded-lg p-4 max-w-2xl">
                <p>${question}</p>
            </div>
            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
        </div>
    `;

    input.value = '';
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Send to API
    try {
        const response = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question })
        });
        const data = await response.json();

        // Add AI response
        messagesDiv.innerHTML += `
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm max-w-2xl">
                    <p class="text-gray-700">${data.answer || data.error || 'Sorry, I could not process that question.'}</p>
                </div>
            </div>
        `;
    } catch (error) {
        messagesDiv.innerHTML += `
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm max-w-2xl">
                    <p class="text-red-600">Sorry, there was an error processing your question.</p>
                </div>
            </div>
        `;
    }

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
{% endblock %}
