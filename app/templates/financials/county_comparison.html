{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">County Comparison Analytics</h2>
            <p class="text-gray-600">Compare {{ our_county }} County against neighboring Florida counties</p>
        </div>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Benchmarking
        </span>
    </div>

    {% if not has_data %}
    <!-- No Data Available -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center">
        <svg class="w-12 h-12 text-yellow-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">No Benchmark Data Available</h3>
        <p class="text-yellow-700 mb-4">
            County comparison data needs to be imported from external sources.
        </p>
        <div class="bg-white rounded-lg p-4 text-left max-w-md mx-auto">
            <p class="text-sm text-gray-600 mb-2">To load sample data, run:</p>
            <code class="block bg-gray-100 p-2 rounded text-sm text-gray-800">
                python scripts/import_county_benchmarks.py --sample
            </code>
        </div>
    </div>
    {% else %}

    <!-- Marion County Ranking Summary -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white">
        <h3 class="text-lg font-semibold mb-4">{{ our_county }} County Performance Summary</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for metric_key, metric_label, metric_type, lower_better in key_metrics[:4] %}
            {% if metrics.get(our_county, {}).get(metric_key) is not none %}
            {% set value = metrics[our_county][metric_key] %}
            {% set rank = rankings.get(metric_key, {}).get(our_county, '-') %}
            <div class="bg-white/10 rounded-lg p-4">
                <p class="text-blue-100 text-sm">{{ metric_label }}</p>
                <p class="text-2xl font-bold">
                    {% if metric_type == 'currency' %}
                    ${{ '{:,.0f}'.format(value) }}
                    {% elif metric_type == 'percent' %}
                    {{ '{:.1f}'.format(value) }}%
                    {% elif metric_type == 'ratio' %}
                    {{ '{:.2f}'.format(value) }}
                    {% else %}
                    {{ value|int }}
                    {% endif %}
                </p>
                <p class="text-sm">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                        {% if rank == 1 %}bg-green-400 text-green-900
                        {% elif rank == 2 %}bg-blue-400 text-blue-900
                        {% elif rank >= counties|length %}bg-red-400 text-red-900
                        {% else %}bg-gray-300 text-gray-700{% endif %}">
                        #{{ rank }} of {{ counties|length }}
                    </span>
                </p>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Key Metrics Comparison Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-900">Key Performance Indicators</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                        {% for county in counties %}
                        <th class="px-6 py-3 text-center text-xs font-medium {% if county == our_county %}text-blue-600 bg-blue-50{% else %}text-gray-500{% endif %} uppercase tracking-wider">
                            {{ county }}
                            {% if county == our_county %}<span class="block text-xs font-normal">(Our County)</span>{% endif %}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for metric_key, metric_label, metric_type, lower_better in key_metrics %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="font-medium text-gray-900">{{ metric_label }}</span>
                            {% if lower_better %}
                            <span class="text-xs text-gray-500">(lower is better)</span>
                            {% endif %}
                        </td>
                        {% for county in counties %}
                        {% set value = metrics.get(county, {}).get(metric_key) %}
                        {% set rank = rankings.get(metric_key, {}).get(county, '-') %}
                        <td class="px-6 py-4 whitespace-nowrap text-center {% if county == our_county %}bg-blue-50{% endif %}">
                            {% if value is not none %}
                            <div class="flex items-center justify-center space-x-2">
                                <span class="{% if rank == 1 %}text-green-600 font-bold{% elif rank == counties|length %}text-red-600{% else %}text-gray-900{% endif %}">
                                    {% if metric_type == 'currency' %}
                                    ${{ '{:,.0f}'.format(value) }}
                                    {% elif metric_type == 'percent' %}
                                    {{ '{:.1f}'.format(value) }}%
                                    {% elif metric_type == 'ratio' %}
                                    {{ '{:.2f}'.format(value) }}
                                    {% else %}
                                    {{ value|int }}
                                    {% endif %}
                                </span>
                                {% if rank == 1 %}
                                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Visual Comparisons -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Delay Rate Comparison -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Delay Rate Comparison</h3>
            <div class="space-y-3">
                {% for county in counties|sort(attribute=metrics.get(county, {}).get('delay_rate', 100)) %}
                {% set delay_rate = metrics.get(county, {}).get('delay_rate', 0) %}
                <div class="flex items-center">
                    <span class="w-20 text-sm font-medium {% if county == our_county %}text-blue-600{% else %}text-gray-700{% endif %}">{{ county }}</span>
                    <div class="flex-1 mx-3">
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full {% if delay_rate < 20 %}bg-green-500{% elif delay_rate < 30 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                 style="width: {{ (delay_rate / 50 * 100)|int }}%"></div>
                        </div>
                    </div>
                    <span class="w-14 text-right text-sm {% if county == our_county %}font-bold text-blue-600{% else %}text-gray-600{% endif %}">
                        {{ '{:.1f}'.format(delay_rate) }}%
                    </span>
                </div>
                {% endfor %}
            </div>
            <p class="text-xs text-gray-500 mt-4">Lower delay rate indicates better schedule performance</p>
        </div>

        <!-- CPI Comparison -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Cost Performance Index (CPI)</h3>
            <div class="space-y-3">
                {% for county in counties|sort(attribute=metrics.get(county, {}).get('avg_cpi', 0), reverse=True) %}
                {% set cpi = metrics.get(county, {}).get('avg_cpi', 0) %}
                <div class="flex items-center">
                    <span class="w-20 text-sm font-medium {% if county == our_county %}text-blue-600{% else %}text-gray-700{% endif %}">{{ county }}</span>
                    <div class="flex-1 mx-3">
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full {% if cpi >= 1.1 %}bg-green-500{% elif cpi >= 1.0 %}bg-blue-500{% elif cpi >= 0.9 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                 style="width: {{ (cpi / 1.5 * 100)|int }}%"></div>
                        </div>
                    </div>
                    <span class="w-14 text-right text-sm {% if county == our_county %}font-bold text-blue-600{% else %}text-gray-600{% endif %}">
                        {{ '{:.2f}'.format(cpi) }}
                    </span>
                </div>
                {% endfor %}
            </div>
            <p class="text-xs text-gray-500 mt-4">CPI > 1.0 means under budget (good), < 1.0 means over budget</p>
        </div>
    </div>

    <!-- Insights Panel -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <svg class="w-5 h-5 inline mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            Key Insights for {{ our_county }} County
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% set our_metrics = metrics.get(our_county, {}) %}

            <!-- Strengths -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h4 class="font-medium text-green-800 mb-2">Strengths</h4>
                <ul class="text-sm text-green-700 space-y-1">
                    {% if rankings.get('avg_cpi', {}).get(our_county, 99) <= 2 %}
                    <li>- Strong cost performance (top {{ rankings.get('avg_cpi', {}).get(our_county, 0) }})</li>
                    {% endif %}
                    {% if rankings.get('local_vendor_pct', {}).get(our_county, 99) <= 2 %}
                    <li>- Good local vendor engagement</li>
                    {% endif %}
                    {% if rankings.get('over_budget_rate', {}).get(our_county, 99) <= 2 %}
                    <li>- Low over-budget rate</li>
                    {% endif %}
                    {% if our_metrics.get('avg_cpi', 0) >= 1.0 %}
                    <li>- Portfolio is on/under budget overall</li>
                    {% endif %}
                </ul>
            </div>

            <!-- Areas for Improvement -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h4 class="font-medium text-yellow-800 mb-2">Areas for Improvement</h4>
                <ul class="text-sm text-yellow-700 space-y-1">
                    {% if rankings.get('delay_rate', {}).get(our_county, 0) >= counties|length - 1 %}
                    <li>- Higher than average delay rate</li>
                    {% endif %}
                    {% if rankings.get('avg_completion', {}).get(our_county, 0) >= counties|length - 1 %}
                    <li>- Project completion rate could improve</li>
                    {% endif %}
                    {% if our_metrics.get('delay_rate', 0) > 25 %}
                    <li>- Over 25% of projects are delayed</li>
                    {% endif %}
                </ul>
            </div>

            <!-- Recommendations -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-medium text-blue-800 mb-2">Recommendations</h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    {% if our_metrics.get('delay_rate', 0) > 20 %}
                    <li>- Review contractor scheduling practices</li>
                    <li>- Consider more aggressive milestone tracking</li>
                    {% endif %}
                    {% if our_metrics.get('local_vendor_pct', 0) < 60 %}
                    <li>- Explore local vendor outreach programs</li>
                    {% endif %}
                    <li>- Continue strong budget management</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Data Sources -->
    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm text-gray-600">
        <p class="font-medium text-gray-700 mb-1">Data Sources & Notes</p>
        <p>Comparison data is sourced from Florida Department of Education reports, county school district annual reports, and state comptroller records. Some values are estimates based on publicly available information. Data should be verified for official oversight reports.</p>
    </div>

    {% endif %}
</div>
{% endblock %}
